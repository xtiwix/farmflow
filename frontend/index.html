<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#059669">
    <title>FarmFlow - Farm Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { margin: 0; padding: 0; background: #f3f4f6; }
        @media (max-width: 768px) {
            .mobile-menu { transform: translateX(-100%); transition: transform 0.3s ease; }
            .mobile-menu.open { transform: translateX(0); }
        }
        .touch-target { min-height: 44px; min-width: 44px; }
        .scroll-smooth { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: white; border-top: 1px solid #e5e7eb;
            padding-bottom: env(safe-area-inset-bottom); z-index: 1000;
        }
        .safe-area-bottom { padding-bottom: calc(60px + env(safe-area-inset-bottom)); }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, createContext, useContext, useCallback, useMemo } = React;

        // API Configuration - uses same origin
        const API_URL = '/api';
        
        const api = axios.create({ baseURL: API_URL });
        
        api.interceptors.request.use(config => {
            const token = localStorage.getItem('farmflow_token');
            if (token) config.headers.Authorization = `Bearer ${token}`;
            return config;
        });
        
        api.interceptors.response.use(
            response => response,
            error => {
                if (error.response?.status === 401) {
                    localStorage.removeItem('farmflow_token');
                    window.location.reload();
                }
                return Promise.reject(error);
            }
        );

        // Contexts
        const AuthContext = createContext(null);
        const useAuth = () => useContext(AuthContext);
        const ToastContext = createContext(null);
        const useToast = () => useContext(ToastContext);

        // Icons
        const Icons = {
            Home: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
            Leaf: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>,
            Users: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            ShoppingCart: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>,
            CheckCircle: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Layers: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>,
            Chart: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
            Menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>,
            X: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
            Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            Search: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
            Bell: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
            Logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
            Edit: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
            Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            Check: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            Clock: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Calendar: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
        };

        // Toast Provider
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const showToast = useCallback((message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            }, []);
            return (
                <ToastContext.Provider value={{ showToast }}>
                    {children}
                    <div className="fixed bottom-20 left-4 right-4 md:left-auto md:right-4 md:w-80 z-50 space-y-2">
                        {toasts.map(toast => (
                            <div key={toast.id} className={`p-4 rounded-lg shadow-lg animate-slide-in ${
                                toast.type === 'success' ? 'bg-green-600' : 
                                toast.type === 'error' ? 'bg-red-600' : 'bg-blue-600'
                            } text-white`}>
                                {toast.message}
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        // Utility Components
        const Spinner = ({ size = 'md' }) => {
            const sizeClasses = { sm: 'w-4 h-4', md: 'w-8 h-8', lg: 'w-12 h-12' };
            return <div className={`${sizeClasses[size]} animate-spin rounded-full border-2 border-gray-300 border-t-emerald-600`} />;
        };

        const Modal = ({ isOpen, onClose, title, children, size = 'md' }) => {
            if (!isOpen) return null;
            const sizeClasses = { sm: 'max-w-md', md: 'max-w-lg', lg: 'max-w-2xl', xl: 'max-w-4xl' };
            return (
                <div className="fixed inset-0 z-50 overflow-y-auto">
                    <div className="flex min-h-screen items-end md:items-center justify-center p-0 md:p-4">
                        <div className="fixed inset-0 bg-black/50" onClick={onClose} />
                        <div className={`relative bg-white w-full ${sizeClasses[size]} rounded-t-2xl md:rounded-xl shadow-xl animate-slide-in`}>
                            <div className="flex items-center justify-between p-4 border-b">
                                <h3 className="text-lg font-semibold">{title}</h3>
                                <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full"><Icons.X /></button>
                            </div>
                            <div className="p-4 max-h-[70vh] overflow-y-auto">{children}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const Button = ({ children, onClick, variant = 'primary', size = 'md', disabled, loading, className = '', type = 'button' }) => {
            const base = 'inline-flex items-center justify-center font-medium rounded-lg transition-colors touch-target';
            const variants = {
                primary: 'bg-emerald-600 text-white hover:bg-emerald-700 disabled:bg-emerald-300',
                secondary: 'bg-gray-100 text-gray-700 hover:bg-gray-200',
                danger: 'bg-red-600 text-white hover:bg-red-700',
                ghost: 'text-gray-600 hover:bg-gray-100'
            };
            const sizes = { sm: 'px-3 py-1.5 text-sm', md: 'px-4 py-2', lg: 'px-6 py-3 text-lg' };
            return (
                <button type={type} onClick={onClick} disabled={disabled || loading}
                    className={`${base} ${variants[variant]} ${sizes[size]} ${className}`}>
                    {loading ? <Spinner size="sm" /> : children}
                </button>
            );
        };

        const Input = ({ label, error, ...props }) => (
            <div className="space-y-1">
                {label && <label className="block text-sm font-medium text-gray-700">{label}</label>}
                <input {...props} className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 touch-target ${
                    error ? 'border-red-500' : 'border-gray-300'
                } ${props.className || ''}`} />
                {error && <p className="text-sm text-red-600">{error}</p>}
            </div>
        );

        const Select = ({ label, options, ...props }) => (
            <div className="space-y-1">
                {label && <label className="block text-sm font-medium text-gray-700">{label}</label>}
                <select {...props} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 touch-target">
                    {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                </select>
            </div>
        );

        const Card = ({ children, className = '', onClick }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-gray-100 ${onClick ? 'cursor-pointer hover:shadow-md' : ''} ${className}`} onClick={onClick}>
                {children}
            </div>
        );

        const Badge = ({ children, variant = 'default' }) => {
            const variants = {
                default: 'bg-gray-100 text-gray-800',
                success: 'bg-green-100 text-green-800',
                warning: 'bg-yellow-100 text-yellow-800',
                danger: 'bg-red-100 text-red-800',
                info: 'bg-blue-100 text-blue-800',
                purple: 'bg-purple-100 text-purple-800'
            };
            return <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${variants[variant]}`}>{children}</span>;
        };

        const EmptyState = ({ icon: Icon, title, description, action }) => (
            <div className="text-center py-12">
                <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                    {Icon && <Icon />}
                </div>
                <h3 className="text-lg font-medium text-gray-900 mb-1">{title}</h3>
                <p className="text-gray-500 mb-4">{description}</p>
                {action}
            </div>
        );

        // Auth Provider
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const token = localStorage.getItem('farmflow_token');
                if (token) fetchUser();
                else setLoading(false);
            }, []);

            const fetchUser = async () => {
                try {
                    const { data } = await api.get('/auth/me');
                    setUser(data.user);
                } catch (error) {
                    localStorage.removeItem('farmflow_token');
                } finally {
                    setLoading(false);
                }
            };

            const login = async (email, password) => {
                const { data } = await api.post('/auth/login', { email, password });
                localStorage.setItem('farmflow_token', data.token);
                setUser(data.user);
                return data;
            };

            const logout = () => {
                localStorage.removeItem('farmflow_token');
                setUser(null);
            };

            return <AuthContext.Provider value={{ user, loading, login, logout, fetchUser }}>{children}</AuthContext.Provider>;
        };

        // Login Page
        const LoginPage = () => {
            const { login } = useAuth();
            const [email, setEmail] = useState('demo@farmflow.com');
            const [password, setPassword] = useState('demo123456');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    await login(email, password);
                } catch (err) {
                    setError(err.response?.data?.error || 'Login failed');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-teal-100 flex items-center justify-center p-4">
                    <div className="w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-emerald-600 mb-4">
                                <span className="text-2xl">üå±</span>
                            </div>
                            <h1 className="text-3xl font-bold text-gray-900">FarmFlow</h1>
                            <p className="text-gray-600 mt-2">Farm Management Platform</p>
                        </div>
                        <Card className="p-6">
                            <form onSubmit={handleSubmit} className="space-y-4">
                                {error && <div className="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">{error}</div>}
                                <Input label="Email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} required />
                                <Input label="Password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} required />
                                <Button type="submit" className="w-full" loading={loading} size="lg">Sign In</Button>
                            </form>
                            <div className="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-600">
                                <p className="font-medium mb-1">Demo Credentials:</p>
                                <p>Email: demo@farmflow.com</p>
                                <p>Password: demo123456</p>
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // Main Layout
        const MainLayout = ({ children, currentPage, setCurrentPage }) => {
            const { user, logout } = useAuth();
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: Icons.Home },
                { id: 'crops', label: 'Crops', icon: Icons.Leaf },
                { id: 'customers', label: 'Customers', icon: Icons.Users },
                { id: 'orders', label: 'Orders', icon: Icons.ShoppingCart },
                { id: 'tasks', label: 'Tasks', icon: Icons.CheckCircle },
                { id: 'batches', label: 'Batches', icon: Icons.Layers },
                { id: 'reports', label: 'Reports', icon: Icons.Chart },
            ];

            return (
                <div className="min-h-screen bg-gray-50">
                    {isMobile && sidebarOpen && <div className="fixed inset-0 bg-black/50 z-40" onClick={() => setSidebarOpen(false)} />}
                    
                    <aside className={`fixed top-0 left-0 h-full w-64 bg-white border-r z-50 transform transition-transform ${
                        isMobile ? (sidebarOpen ? 'translate-x-0' : '-translate-x-full') : 'translate-x-0'
                    }`}>
                        <div className="flex items-center gap-3 p-4 border-b">
                            <div className="w-10 h-10 rounded-xl bg-emerald-600 flex items-center justify-center">
                                <span className="text-lg">üå±</span>
                            </div>
                            <div>
                                <h1 className="font-bold text-gray-900">FarmFlow</h1>
                                <p className="text-xs text-gray-500">v2.0.0</p>
                            </div>
                        </div>
                        <nav className="p-4 space-y-1">
                            {navItems.map(item => (
                                <button key={item.id} onClick={() => { setCurrentPage(item.id); setSidebarOpen(false); }}
                                    className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left touch-target ${
                                        currentPage === item.id ? 'bg-emerald-50 text-emerald-700' : 'text-gray-600 hover:bg-gray-50'
                                    }`}>
                                    <item.icon /><span className="font-medium">{item.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="absolute bottom-0 left-0 right-0 p-4 border-t">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center">
                                    <span className="text-emerald-700 font-medium text-sm">{user?.firstName?.[0]}{user?.lastName?.[0]}</span>
                                </div>
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium truncate">{user?.firstName} {user?.lastName}</p>
                                    <p className="text-xs text-gray-500 truncate">{user?.email}</p>
                                </div>
                            </div>
                            <button onClick={logout} className="w-full flex items-center gap-2 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                                <Icons.Logout /><span>Sign Out</span>
                            </button>
                        </div>
                    </aside>

                    <main className={`${isMobile ? '' : 'ml-64'} min-h-screen pb-20 md:pb-0`}>
                        <header className="bg-white border-b sticky top-0 z-30">
                            <div className="flex items-center justify-between px-4 py-3">
                                {isMobile && <button onClick={() => setSidebarOpen(true)} className="p-2 hover:bg-gray-100 rounded-lg"><Icons.Menu /></button>}
                                <h2 className="text-xl font-semibold capitalize">{currentPage}</h2>
                                <button className="p-2 hover:bg-gray-100 rounded-lg relative">
                                    <Icons.Bell /><span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full" />
                                </button>
                            </div>
                        </header>
                        <div className="p-4 md:p-6">{children}</div>
                    </main>

                    {isMobile && (
                        <nav className="bottom-nav">
                            <div className="flex justify-around py-2">
                                {navItems.slice(0, 5).map(item => (
                                    <button key={item.id} onClick={() => setCurrentPage(item.id)}
                                        className={`flex flex-col items-center gap-1 p-2 ${currentPage === item.id ? 'text-emerald-600' : 'text-gray-400'}`}>
                                        <item.icon /><span className="text-xs">{item.label}</span>
                                    </button>
                                ))}
                            </div>
                        </nav>
                    )}
                </div>
            );
        };

        // Dashboard Page
        const DashboardPage = () => {
            const [data, setData] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const { showToast } = useToast();

            useEffect(() => { fetchDashboard(); }, []);

            const fetchDashboard = async () => {
                try {
                    const [overviewRes, tasksRes] = await Promise.all([
                        api.get('/dashboard/overview'),
                        api.get('/dashboard/today-tasks')
                    ]);
                    setData(overviewRes.data.overview);
                    setTasks(tasksRes.data.tasks || []);
                } catch (error) {
                    showToast('Failed to load dashboard', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const completeTask = async (taskId) => {
                try {
                    await api.patch(`/tasks/${taskId}/complete`);
                    setTasks(prev => prev.map(t => t.id === taskId ? { ...t, status: 'completed' } : t));
                    showToast('Task completed!');
                } catch (error) {
                    showToast('Failed to complete task', 'error');
                }
            };

            if (loading) return <div className="flex justify-center h-64"><Spinner size="lg" /></div>;

            const stats = [
                { label: 'Revenue This Month', value: `$${parseFloat(data?.revenue?.thisMonth || 0).toLocaleString()}` },
                { label: 'Pending Orders', value: data?.orders?.pending || 0 },
                { label: 'Active Batches', value: data?.batches?.active || 0 },
                { label: 'Today\'s Deliveries', value: data?.orders?.todayDeliveries || 0 },
                { label: 'Overdue Tasks', value: data?.tasks?.overdue || 0, alert: data?.tasks?.overdue > 0 },
                { label: 'Customers', value: data?.customers || 0 },
            ];

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        {stats.map((stat, i) => (
                            <Card key={i} className="p-4">
                                <p className="text-sm text-gray-500 mb-1">{stat.label}</p>
                                <p className={`text-2xl font-bold ${stat.alert ? 'text-red-600' : ''}`}>{stat.value}</p>
                            </Card>
                        ))}
                    </div>
                    <Card>
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="font-semibold">Today's Tasks</h3>
                            <Badge variant="info">{tasks.filter(t => t.status === 'pending').length} pending</Badge>
                        </div>
                        <div className="divide-y">
                            {tasks.length === 0 ? (
                                <div className="p-8 text-center text-gray-500">No tasks for today</div>
                            ) : tasks.slice(0, 8).map(task => (
                                <div key={task.id} className="p-4 flex items-center gap-4">
                                    <button onClick={() => task.status === 'pending' && completeTask(task.id)}
                                        className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                                            task.status === 'completed' ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-gray-300 hover:border-emerald-500'
                                        }`}>
                                        {task.status === 'completed' && <Icons.Check />}
                                    </button>
                                    <div className="flex-1">
                                        <p className={`font-medium ${task.status === 'completed' ? 'line-through text-gray-400' : ''}`}>{task.title}</p>
                                        <div className="flex items-center gap-2 mt-1">
                                            {task.Crop && <Badge variant={task.Crop.category === 'microgreens' ? 'success' : 'purple'}>{task.Crop.name}</Badge>}
                                        </div>
                                    </div>
                                    <Badge variant={task.priority === 'high' ? 'danger' : task.priority === 'medium' ? 'warning' : 'default'}>{task.priority}</Badge>
                                </div>
                            ))}
                        </div>
                    </Card>
                </div>
            );
        };

        // Crops Page
        const CropsPage = () => {
            const [crops, setCrops] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showModal, setShowModal] = useState(false);
            const [editingCrop, setEditingCrop] = useState(null);
            const [filter, setFilter] = useState('all');
            const [search, setSearch] = useState('');
            const { showToast } = useToast();

            useEffect(() => { fetchCrops(); }, []);

            const fetchCrops = async () => {
                try {
                    const { data } = await api.get('/crops');
                    setCrops(data.crops || []);
                } catch (error) {
                    showToast('Failed to load crops', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleSave = async (cropData) => {
                try {
                    if (editingCrop) {
                        await api.put(`/crops/${editingCrop.id}`, cropData);
                        showToast('Crop updated');
                    } else {
                        await api.post('/crops', cropData);
                        showToast('Crop created');
                    }
                    fetchCrops();
                    setShowModal(false);
                    setEditingCrop(null);
                } catch (error) {
                    showToast('Failed to save crop', 'error');
                }
            };

            const handleDelete = async (id) => {
                if (!confirm('Delete this crop?')) return;
                try {
                    await api.delete(`/crops/${id}`);
                    showToast('Crop deleted');
                    fetchCrops();
                } catch (error) {
                    showToast('Failed to delete', 'error');
                }
            };

            const filteredCrops = crops.filter(crop => 
                (filter === 'all' || crop.category === filter) &&
                (crop.name?.toLowerCase().includes(search.toLowerCase()) || crop.variety?.toLowerCase().includes(search.toLowerCase()))
            );

            if (loading) return <div className="flex justify-center h-64"><Spinner size="lg" /></div>;

            return (
                <div className="space-y-4 animate-fade-in">
                    <div className="flex flex-col sm:flex-row gap-3 justify-between">
                        <div className="flex gap-2 flex-wrap">
                            {['all', 'microgreens', 'mushrooms'].map(f => (
                                <button key={f} onClick={() => setFilter(f)}
                                    className={`px-4 py-2 rounded-lg font-medium capitalize ${
                                        filter === f ? 'bg-emerald-600 text-white' : 'bg-white border hover:bg-gray-50'
                                    }`}>{f}</button>
                            ))}
                        </div>
                        <div className="flex gap-2">
                            <input type="text" placeholder="Search..." value={search} onChange={(e) => setSearch(e.target.value)}
                                className="px-3 py-2 border rounded-lg" />
                            <Button onClick={() => setShowModal(true)}><Icons.Plus /><span className="ml-2">Add</span></Button>
                        </div>
                    </div>

                    {filteredCrops.length === 0 ? (
                        <EmptyState icon={Icons.Leaf} title="No crops" description="Add crops to get started"
                            action={<Button onClick={() => setShowModal(true)}>Add Crop</Button>} />
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {filteredCrops.map(crop => (
                                <Card key={crop.id} className="p-4">
                                    <div className="flex items-start justify-between mb-3">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: (crop.color || '#10B981') + '20' }}>
                                                <span style={{ color: crop.color || '#10B981' }}>{crop.category === 'microgreens' ? 'üå±' : 'üçÑ'}</span>
                                            </div>
                                            <div>
                                                <h3 className="font-semibold">{crop.name}</h3>
                                                {crop.variety && <p className="text-sm text-gray-500">{crop.variety}</p>}
                                            </div>
                                        </div>
                                        <Badge variant={crop.category === 'microgreens' ? 'success' : 'purple'}>{crop.category}</Badge>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 text-sm mb-4">
                                        <div><p className="text-gray-500">Growth</p><p className="font-medium">{crop.growthDays} days</p></div>
                                        <div><p className="text-gray-500">Yield</p><p className="font-medium">{crop.yieldPerTray || crop.yieldPerBlock} {crop.unit}</p></div>
                                        <div><p className="text-gray-500">Price</p><p className="font-medium">${crop.pricePerUnit}/{crop.unit}</p></div>
                                        <div><p className="text-gray-500">Cost</p><p className="font-medium">${crop.costPerTray || crop.costPerBlock || 0}</p></div>
                                    </div>
                                    <div className="flex gap-2">
                                        <Button variant="secondary" size="sm" className="flex-1" onClick={() => { setEditingCrop(crop); setShowModal(true); }}>
                                            <Icons.Edit /><span className="ml-1">Edit</span>
                                        </Button>
                                        <Button variant="ghost" size="sm" onClick={() => handleDelete(crop.id)}><Icons.Trash /></Button>
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}

                    <Modal isOpen={showModal} onClose={() => { setShowModal(false); setEditingCrop(null); }} 
                        title={editingCrop ? 'Edit Crop' : 'Add Crop'} size="lg">
                        <CropForm crop={editingCrop} onSave={handleSave} onCancel={() => { setShowModal(false); setEditingCrop(null); }} />
                    </Modal>
                </div>
            );
        };

        const CropForm = ({ crop, onSave, onCancel }) => {
            const [form, setForm] = useState({
                name: '', variety: '', category: 'microgreens', growthDays: 10, blackoutDays: 3,
                soakTime: 8, yieldPerTray: 8, yieldPerBlock: 2, unit: 'oz', pricePerUnit: 4,
                costPerTray: 1.5, costPerBlock: 3, color: '#10B981', notes: ''
            });

            useEffect(() => { if (crop) setForm({ ...crop }); }, [crop]);

            return (
                <form onSubmit={(e) => { e.preventDefault(); onSave(form); }} className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <Input label="Name" value={form.name} onChange={(e) => setForm(p => ({ ...p, name: e.target.value }))} required />
                        <Input label="Variety" value={form.variety} onChange={(e) => setForm(p => ({ ...p, variety: e.target.value }))} />
                    </div>
                    <Select label="Category" value={form.category} onChange={(e) => setForm(p => ({ ...p, category: e.target.value }))}
                        options={[{ value: 'microgreens', label: 'Microgreens' }, { value: 'mushrooms', label: 'Mushrooms' }]} />
                    <div className="grid grid-cols-3 gap-4">
                        <Input label="Growth Days" type="number" value={form.growthDays} onChange={(e) => setForm(p => ({ ...p, growthDays: parseInt(e.target.value) }))} />
                        <Input label="Blackout Days" type="number" value={form.blackoutDays} onChange={(e) => setForm(p => ({ ...p, blackoutDays: parseInt(e.target.value) }))} />
                        <Input label="Soak Time (hrs)" type="number" value={form.soakTime} onChange={(e) => setForm(p => ({ ...p, soakTime: parseFloat(e.target.value) }))} />
                    </div>
                    <div className="grid grid-cols-3 gap-4">
                        <Input label={form.category === 'microgreens' ? 'Yield/Tray' : 'Yield/Block'} type="number" step="0.1"
                            value={form.category === 'microgreens' ? form.yieldPerTray : form.yieldPerBlock}
                            onChange={(e) => setForm(p => ({ ...p, [form.category === 'microgreens' ? 'yieldPerTray' : 'yieldPerBlock']: parseFloat(e.target.value) }))} />
                        <Input label="Unit" value={form.unit} onChange={(e) => setForm(p => ({ ...p, unit: e.target.value }))} />
                        <Input label="Price/Unit" type="number" step="0.01" value={form.pricePerUnit} onChange={(e) => setForm(p => ({ ...p, pricePerUnit: parseFloat(e.target.value) }))} />
                    </div>
                    <div className="flex gap-3 pt-4">
                        <Button type="button" variant="secondary" onClick={onCancel} className="flex-1">Cancel</Button>
                        <Button type="submit" className="flex-1">{crop ? 'Update' : 'Create'}</Button>
                    </div>
                </form>
            );
        };

        // Customers Page
        const CustomersPage = () => {
            const [customers, setCustomers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showModal, setShowModal] = useState(false);
            const [editingCustomer, setEditingCustomer] = useState(null);
            const { showToast } = useToast();

            useEffect(() => { fetchCustomers(); }, []);

            const fetchCustomers = async () => {
                try {
                    const { data } = await api.get('/customers');
                    setCustomers(data.customers || []);
                } catch (error) {
                    showToast('Failed to load customers', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleSave = async (data) => {
                try {
                    if (editingCustomer) await api.put(`/customers/${editingCustomer.id}`, data);
                    else await api.post('/customers', data);
                    showToast(editingCustomer ? 'Customer updated' : 'Customer created');
                    fetchCustomers();
                    setShowModal(false);
                    setEditingCustomer(null);
                } catch (error) {
                    showToast('Failed to save', 'error');
                }
            };

            if (loading) return <div className="flex justify-center h-64"><Spinner size="lg" /></div>;

            return (
                <div className="space-y-4 animate-fade-in">
                    <div className="flex justify-end">
                        <Button onClick={() => setShowModal(true)}><Icons.Plus /><span className="ml-2">Add Customer</span></Button>
                    </div>
                    {customers.length === 0 ? (
                        <EmptyState icon={Icons.Users} title="No customers" description="Add your first customer" />
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {customers.map(customer => (
                                <Card key={customer.id} className="p-4">
                                    <div className="flex justify-between mb-3">
                                        <div>
                                            <h3 className="font-semibold">{customer.businessName || customer.contactName}</h3>
                                            {customer.businessName && <p className="text-sm text-gray-500">{customer.contactName}</p>}
                                        </div>
                                        <Badge variant="info">{customer.type}</Badge>
                                    </div>
                                    <div className="text-sm text-gray-600 space-y-1 mb-3">
                                        {customer.email && <p>{customer.email}</p>}
                                        {customer.phone && <p>{customer.phone}</p>}
                                    </div>
                                    <Button variant="secondary" size="sm" className="w-full"
                                        onClick={() => { setEditingCustomer(customer); setShowModal(true); }}>Edit</Button>
                                </Card>
                            ))}
                        </div>
                    )}
                    <Modal isOpen={showModal} onClose={() => { setShowModal(false); setEditingCustomer(null); }}
                        title={editingCustomer ? 'Edit Customer' : 'Add Customer'} size="lg">
                        <CustomerForm customer={editingCustomer} onSave={handleSave} onCancel={() => { setShowModal(false); setEditingCustomer(null); }} />
                    </Modal>
                </div>
            );
        };

        const CustomerForm = ({ customer, onSave, onCancel }) => {
            const [form, setForm] = useState({ type: 'restaurant', businessName: '', contactName: '', email: '', phone: '', address: '', city: '', state: '', zipCode: '' });
            useEffect(() => { if (customer) setForm({ ...customer }); }, [customer]);
            return (
                <form onSubmit={(e) => { e.preventDefault(); onSave(form); }} className="space-y-4">
                    <Select label="Type" value={form.type} onChange={(e) => setForm(p => ({ ...p, type: e.target.value }))}
                        options={[{ value: 'restaurant', label: 'Restaurant' }, { value: 'retail', label: 'Retail' }, { value: 'wholesale', label: 'Wholesale' }, { value: 'individual', label: 'Individual' }]} />
                    <Input label="Business Name" value={form.businessName} onChange={(e) => setForm(p => ({ ...p, businessName: e.target.value }))} />
                    <Input label="Contact Name" value={form.contactName} onChange={(e) => setForm(p => ({ ...p, contactName: e.target.value }))} required />
                    <div className="grid grid-cols-2 gap-4">
                        <Input label="Email" type="email" value={form.email} onChange={(e) => setForm(p => ({ ...p, email: e.target.value }))} />
                        <Input label="Phone" value={form.phone} onChange={(e) => setForm(p => ({ ...p, phone: e.target.value }))} />
                    </div>
                    <div className="flex gap-3 pt-4">
                        <Button type="button" variant="secondary" onClick={onCancel} className="flex-1">Cancel</Button>
                        <Button type="submit" className="flex-1">{customer ? 'Update' : 'Create'}</Button>
                    </div>
                </form>
            );
        };

        // Orders Page
        const OrdersPage = () => {
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState('all');
            const { showToast } = useToast();

            useEffect(() => { fetchOrders(); }, []);

            const fetchOrders = async () => {
                try {
                    const { data } = await api.get('/orders');
                    setOrders(data.orders || []);
                } catch (error) {
                    showToast('Failed to load orders', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const updateStatus = async (id, status) => {
                try {
                    await api.patch(`/orders/${id}/status`, { status });
                    showToast('Status updated');
                    fetchOrders();
                } catch (error) {
                    showToast('Failed to update', 'error');
                }
            };

            const filteredOrders = orders.filter(o => filter === 'all' || o.status === filter || o.type === filter);
            const statusColors = { pending: 'warning', confirmed: 'info', in_production: 'purple', ready: 'success', delivered: 'default', cancelled: 'danger' };

            if (loading) return <div className="flex justify-center h-64"><Spinner size="lg" /></div>;

            return (
                <div className="space-y-4 animate-fade-in">
                    <div className="flex flex-wrap gap-2">
                        {['all', 'pending', 'confirmed', 'in_production', 'ready', 'delivered'].map(f => (
                            <button key={f} onClick={() => setFilter(f)}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium capitalize ${
                                    filter === f ? 'bg-emerald-600 text-white' : 'bg-white border hover:bg-gray-50'
                                }`}>{f.replace('_', ' ')}</button>
                        ))}
                    </div>
                    {filteredOrders.length === 0 ? (
                        <EmptyState icon={Icons.ShoppingCart} title="No orders" description="Orders will appear here" />
                    ) : (
                        <div className="space-y-3">
                            {filteredOrders.map(order => (
                                <Card key={order.id} className="p-4">
                                    <div className="flex flex-col sm:flex-row justify-between gap-3">
                                        <div>
                                            <div className="flex items-center gap-2 mb-1">
                                                <h3 className="font-semibold">{order.orderNumber}</h3>
                                                <Badge variant={statusColors[order.status]}>{order.status?.replace('_', ' ')}</Badge>
                                                {order.type === 'standing' && <Badge variant="purple">Standing</Badge>}
                                            </div>
                                            <p className="text-sm text-gray-600">{order.Customer?.businessName || order.Customer?.contactName}</p>
                                            <p className="text-sm text-gray-500">Delivery: {new Date(order.deliveryDate).toLocaleDateString()}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-xl font-bold">${parseFloat(order.total || 0).toFixed(2)}</p>
                                            <p className="text-sm text-gray-500">{order.items?.length || 0} items</p>
                                        </div>
                                    </div>
                                    {order.items?.length > 0 && (
                                        <div className="mt-3 pt-3 border-t flex flex-wrap gap-2">
                                            {order.items.map((item, i) => (
                                                <span key={i} className="text-sm bg-gray-100 px-2 py-1 rounded">
                                                    {item.Crop?.name}: {item.quantity} {item.unit}
                                                </span>
                                            ))}
                                        </div>
                                    )}
                                    {!['delivered', 'cancelled'].includes(order.status) && (
                                        <div className="mt-3 pt-3 border-t flex gap-2">
                                            {order.status === 'pending' && <Button size="sm" onClick={() => updateStatus(order.id, 'confirmed')}>Confirm</Button>}
                                            {order.status === 'confirmed' && <Button size="sm" onClick={() => updateStatus(order.id, 'in_production')}>Start</Button>}
                                            {order.status === 'in_production' && <Button size="sm" onClick={() => updateStatus(order.id, 'ready')}>Ready</Button>}
                                            {order.status === 'ready' && <Button size="sm" onClick={() => updateStatus(order.id, 'delivered')}>Delivered</Button>}
                                        </div>
                                    )}
                                </Card>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Tasks Page
        const TasksPage = () => {
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('today');
            const { showToast } = useToast();

            useEffect(() => { fetchTasks(); }, [view]);

            const fetchTasks = async () => {
                setLoading(true);
                try {
                    const { data } = await api.get(`/tasks?view=${view}`);
                    setTasks(data.tasks || []);
                } catch (error) {
                    showToast('Failed to load tasks', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const completeTask = async (id) => {
                try {
                    await api.patch(`/tasks/${id}/complete`);
                    showToast('Task completed!');
                    fetchTasks();
                } catch (error) {
                    showToast('Failed', 'error');
                }
            };

            const groupedTasks = useMemo(() => {
                const groups = {};
                tasks.forEach(task => {
                    const date = new Date(task.dueDate).toLocaleDateString();
                    if (!groups[date]) groups[date] = [];
                    groups[date].push(task);
                });
                return groups;
            }, [tasks]);

            if (loading) return <div className="flex justify-center h-64"><Spinner size="lg" /></div>;

            return (
                <div className="space-y-4 animate-fade-in">
                    <div className="flex gap-2">
                        {['today', 'week', 'month'].map(v => (
                            <button key={v} onClick={() => setView(v)}
                                className={`px-4 py-2 rounded-lg font-medium ${view === v ? 'bg-emerald-600 text-white' : 'bg-white border'}`}>
                                {v === 'today' ? 'Today' : v === 'week' ? 'This Week' : 'This Month'}
                            </button>
                        ))}
                    </div>
                    {tasks.length === 0 ? (
                        <EmptyState icon={Icons.CheckCircle} title="No tasks" description={`No tasks for ${view}`} />
                    ) : (
                        <div className="space-y-6">
                            {Object.entries(groupedTasks).map(([date, dateTasks]) => (
                                <div key={date}>
                                    <h3 className="font-semibold text-gray-700 mb-3">{date}</h3>
                                    <div className="space-y-2">
                                        {dateTasks.map(task => (
                                            <Card key={task.id} className="p-4">
                                                <div className="flex items-center gap-4">
                                                    <button onClick={() => task.status === 'pending' && completeTask(task.id)}
                                                        className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                                                            task.status === 'completed' ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-gray-300'
                                                        }`}>
                                                        {task.status === 'completed' && <Icons.Check />}
                                                    </button>
                                                    <div className="flex-1">
                                                        <p className={`font-medium ${task.status === 'completed' ? 'line-through text-gray-400' : ''}`}>{task.title}</p>
                                                        <div className="flex flex-wrap gap-2 mt-1">
                                                            {task.Crop && <Badge variant={task.Crop.category === 'microgreens' ? 'success' : 'purple'}>{task.Crop.name}</Badge>}
                                                            <Badge variant={task.priority === 'high' ? 'danger' : 'default'}>{task.priority}</Badge>
                                                        </div>
                                                    </div>
                                                </div>
                                            </Card>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Batches Page
        const BatchesPage = () => {
            const [batches, setBatches] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState('active');
            const { showToast } = useToast();

            useEffect(() => { fetchBatches(); }, []);

            const fetchBatches = async () => {
                try {
                    const { data } = await api.get('/batches');
                    setBatches(data.batches || []);
                } catch (error) {
                    showToast('Failed to load batches', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const filteredBatches = batches.filter(b => {
                if (filter === 'active') return !['harvested', 'failed'].includes(b.status);
                if (filter === 'harvested') return b.status === 'harvested';
                return true;
            });

            const statusColors = { planned: 'default', soaking: 'info', growing: 'success', blackout: 'purple', fruiting: 'warning', ready: 'success', harvested: 'default', failed: 'danger' };

            if (loading) return <div className="flex justify-center h-64"><Spinner size="lg" /></div>;

            return (
                <div className="space-y-4 animate-fade-in">
                    <div className="flex gap-2">
                        {['active', 'harvested', 'all'].map(f => (
                            <button key={f} onClick={() => setFilter(f)}
                                className={`px-4 py-2 rounded-lg font-medium capitalize ${filter === f ? 'bg-emerald-600 text-white' : 'bg-white border'}`}>{f}</button>
                        ))}
                    </div>
                    {filteredBatches.length === 0 ? (
                        <EmptyState icon={Icons.Layers} title="No batches" description="Batches will appear here" />
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {filteredBatches.map(batch => (
                                <Card key={batch.id} className="p-4">
                                    <div className="flex justify-between mb-3">
                                        <div>
                                            <h3 className="font-semibold">{batch.batchNumber}</h3>
                                            <p className="text-sm text-gray-600">{batch.Crop?.name}</p>
                                        </div>
                                        <Badge variant={statusColors[batch.status]}>{batch.status}</Badge>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 text-sm">
                                        <div><p className="text-gray-500">Trays/Blocks</p><p className="font-medium">{batch.trayCount || batch.blockCount}</p></div>
                                        <div><p className="text-gray-500">Expected</p><p className="font-medium">{batch.expectedYield} {batch.yieldUnit}</p></div>
                                        <div><p className="text-gray-500">Start</p><p className="font-medium">{new Date(batch.startDate).toLocaleDateString()}</p></div>
                                        <div><p className="text-gray-500">Harvest</p><p className="font-medium">{new Date(batch.expectedHarvestDate).toLocaleDateString()}</p></div>
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Reports Page
        const ReportsPage = () => {
            const [report, setReport] = useState(null);
            const [reportType, setReportType] = useState('sales');
            const [loading, setLoading] = useState(true);
            const { showToast } = useToast();

            useEffect(() => { fetchReport(); }, [reportType]);

            const fetchReport = async () => {
                setLoading(true);
                try {
                    const { data } = await api.get(`/reports/${reportType}`);
                    setReport(data.report);
                } catch (error) {
                    showToast('Failed to load report', 'error');
                } finally {
                    setLoading(false);
                }
            };

            if (loading) return <div className="flex justify-center h-64"><Spinner size="lg" /></div>;

            return (
                <div className="space-y-4 animate-fade-in">
                    <div className="flex gap-2">
                        {['sales', 'production', 'customers'].map(t => (
                            <button key={t} onClick={() => setReportType(t)}
                                className={`px-4 py-2 rounded-lg font-medium capitalize ${reportType === t ? 'bg-emerald-600 text-white' : 'bg-white border'}`}>{t}</button>
                        ))}
                    </div>
                    {reportType === 'sales' && report?.summary && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <Card className="p-4"><p className="text-sm text-gray-500">Total Revenue</p><p className="text-2xl font-bold">${report.summary.totalRevenue}</p></Card>
                            <Card className="p-4"><p className="text-sm text-gray-500">Orders</p><p className="text-2xl font-bold">{report.summary.orderCount}</p></Card>
                            <Card className="p-4"><p className="text-sm text-gray-500">Avg Order</p><p className="text-2xl font-bold">${report.summary.avgOrderValue}</p></Card>
                        </div>
                    )}
                    {reportType === 'customers' && report?.customers && (
                        <Card>
                            <div className="p-4 border-b"><h3 className="font-semibold">Customer Revenue</h3></div>
                            <div className="divide-y">
                                {report.customers.slice(0, 10).map(c => (
                                    <div key={c.id} className="p-4 flex justify-between">
                                        <div>
                                            <p className="font-medium">{c.businessName || c.contactName}</p>
                                            <p className="text-sm text-gray-500">{c.totalOrders} orders</p>
                                        </div>
                                        <p className="font-bold">${parseFloat(c.totalRevenue || 0).toFixed(2)}</p>
                                    </div>
                                ))}
                            </div>
                        </Card>
                    )}
                </div>
            );
        };

        // Main App
        const App = () => {
            const { user, loading } = useAuth();
            const [currentPage, setCurrentPage] = useState('dashboard');

            if (loading) return <div className="min-h-screen flex items-center justify-center"><Spinner size="lg" /></div>;
            if (!user) return <LoginPage />;

            const renderPage = () => {
                switch (currentPage) {
                    case 'dashboard': return <DashboardPage />;
                    case 'crops': return <CropsPage />;
                    case 'customers': return <CustomersPage />;
                    case 'orders': return <OrdersPage />;
                    case 'tasks': return <TasksPage />;
                    case 'batches': return <BatchesPage />;
                    case 'reports': return <ReportsPage />;
                    default: return <DashboardPage />;
                }
            };

            return <MainLayout currentPage={currentPage} setCurrentPage={setCurrentPage}>{renderPage()}</MainLayout>;
        };

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <AuthProvider>
                <ToastProvider>
                    <App />
                </ToastProvider>
            </AuthProvider>
        );
    </script>
</body>
</html>
